<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script Referrer-Policy: no-referrer-when-downgrade src="https://accounts.google.com/gsi/client" async defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.js" integrity="sha512-YeeA/Qxn5hYdkukScTCNNOhTrv1C2RubAGButJ1rmgQwZf/HdRaCGl+JAVkqsqaNRaYNHdheiuKKuPf9mDcqKg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js" integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link rel="stylesheet" href="/public/css/style.css"/>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet"> 

        <title>Tela Inicial</title>
    </head>
    <body>
        <div class="conteudo-inicial">
            <div class="barra-lateral">
                <img class="logo" src="../public/img/wwAsset6.png">
                <h2>Contatos</h2>
                <div class="div-1">
                    <div>
                        <% for(let i = 0; i < listaUsuarios.length; i++) {%>
                        <form id='<%= i %>' class="form">
                            <input type="submit" name="to" value='<%= listaUsuarios[i].name[0].toUpperCase() + listaUsuarios[i].name.substr(1) %>'></>
                            <i class="fa fa-ellipsis-vertical"></i>
                        </form>
                        <% } %>
                    </div>   
                </div>
                
                <h2>Grupos</h2>
                <div class="div-1">
                    <div>
                        <% for(let i = 0; i < listaUsuarios.length; i++) {%>
                        <form class="form">
                            <input type="submit" name="to" value='<%= listaUsuarios[i].name[0].toUpperCase() + listaUsuarios[i].name.substr(1) %>'></>
                            <i class="fa fa-ellipsis-vertical"></i>
                        </form>
                        <% } %>
                    </div>  
                </div>
                
                <div class="div-2">
                    <div><img src=""><i class="fa-regular fa-circle-user"></i></div>
                    <input id="user" name="user" required="required" type="text" placeholder="Usuário" readonly/>
                    <input id="email" name="email" required="required" type="text" placeholder="E-mail" readonly/>
                    <% if(auth == 'databaseAuth'){ %>
                        <form id="formAltSenha" method="GET" action="/trocarSenha">
                            <input type="text" name="auth" value="databaseAuth" hidden>
                            <div class="psswd">
                                <button id="psswd">Alterar senha</button>
                            </div>
                        </form>
                    <% } %>
                </div>
            </div>
            <div class="barra-superior">
                <button title="Criar Grupo"><i class="fa-solid fa-users"></i></button>
                <button title="Foto de perfil"><i class="fa-solid fa-camera"></i></button>
                <button title="Configurações"><i class="fa fa-gear"></i></button>
                <form id="chat" class="div-mensagens">
                    <div class="texto-mensagens"></div>
                    <div class="input-mensagens">
                        <input name="toDo" value='0' hidden></>
                        <input type="text" name="mensagem" placeholder="Digite uma mensagem..." autocomplete="off">
                        <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            document.getElementById("user").value = '<%= usuario %>';
            document.getElementById("email").value = '<%= email %>';
        </script>

        <script type="text/javascript">
            var socket = io();

            async function renderMessageFrom(message) {
                await $('.texto-mensagens').append('<div class="envia"><strong>' + message.users.from + '</strong>:' + message.message + '</div><br>')
            }

            async function renderMessageTo(message) {
                await $('.texto-mensagens').append('<div class="recebe"><strong>' + message.users.from + '</strong>:' + message.message + '</div><br>')
            }

            $('.form').submit(function(event) {
                event.preventDefault();
                let id = $(this).attr("id");
                let from = $('input[name=user]').val();
                let to = $(`#${id}`).find(`input[name=to]`).val();
                let toDo = $('input[name=toDo]').val(`${to}`);
                let mensagemObj = {
                    users: {
                        from: from,
                        to: to,
                        }
                    };
                    $('.texto-mensagens').html("");
                    socket.emit('escolhaPessoa', mensagemObj);
                });
           
            socket.on('previousMessageFrom', async function(msgsDatabaseFrom) {
                for (let i = 0; i < msgsDatabaseFrom.length; i++) {
                    const data = msgsDatabaseFrom[i]['createdAt'];
                    const from = msgsDatabaseFrom[i]['users']['from'];
                    const to = msgsDatabaseFrom[i]['users']['to'];
                    const message = msgsDatabaseFrom[i]['message'];
                    console.log(data)
                    let objdatabaseFrom = {
                        message: message,
                        users: {
                            from: from,
                            to: to,
                        }
                    };
                    await renderMessageFrom(objdatabaseFrom);
                }
            }); 

            socket.on('previousMessageTo', async function(msgsDatabaseTo) {
                for (let i = 0; i < msgsDatabaseTo.length; i++) {
                    const data = msgsDatabaseTo[i]['createdAt'];
                    const from = msgsDatabaseTo[i]['users']['from'];
                    const to = msgsDatabaseTo[i]['users']['to'];
                    const message = msgsDatabaseTo[i]['message'];
                    console.log(data)
                    let objdatabaseTo = {
                        message: message,
                        users: {
                            from: from,
                            to: to,
                        }
                    };
                    await renderMessageTo(objdatabaseTo);
                }
            });

            
            $('#chat').submit(function(event) {
                event.preventDefault();
                let from = $('input[name=user]').val();
                let toDos = $('input[name=toDo]').val();
                let message = $('input[name=mensagem]').val();
    
                    if (from.length && message.length) {
                        let mensagemObj = {
                        message: message,
                        users: {
                            from: from,
                            to: toDos,
                        }
                    };
                    renderMessageFrom(mensagemObj);
                    socket.emit('sendMessage', mensagemObj);
                    $('input[name=mensagem]').val("");
                }
            });
        </script>

        <!-- Ícones -->
        <script src="https://kit.fontawesome.com/a9ac96b7ba.js" 
        crossorigin="anonymous"></script>
    </body>
</html>